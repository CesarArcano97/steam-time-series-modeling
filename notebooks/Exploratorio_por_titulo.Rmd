---
title: "Modelado de Series de Tiempo: Team Fortress 2"
author: "C칠sar - Maestr칤a en C칩mputo Estad칤stico"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: true
    toc_float: true
    theme: united
---

```{r}
INPUT_FILE <- "/home/cesar/steam-time-series-modeling/data/processed/tf2_dataset_unificado.csv"

datos <- read_csv(INPUT_FILE) %>%
  mutate(fecha = as.Date(fecha))

```

```{r}
library(ggplot2)
library(dplyr)
library(readr)

# 1. Configuraci칩n de Juegos (Slug del archivo -> T칤tulo del Gr치fico)
juegos_config <- list(
  "tf2"            = "Team Fortress 2",
  "cs2"            = "Counter-Strike 2",
  "eve_online"     = "EVE Online",
  "cyberpunk_2077" = "Cyberpunk 2077",
  "dwarf_fortress" = "Dwarf Fortress"
)

# 2. Bucle Maestro
cat("Generando gr치ficos de validaci칩n para todos los juegos...\n\n")

for (slug in names(juegos_config)) {
  
  titulo_juego <- juegos_config[[slug]]
  archivo <- paste0("/home/cesar/steam-time-series-modeling/data/processed/", slug, "_dataset_unificado.csv")
  
  if(file.exists(archivo)) {
    
    # Cargar datos
    df <- read_csv(archivo, show_col_types = FALSE)
    df$fecha <- as.Date(df$fecha)
    
    # Filtro Zoom (2023 en adelante)
    df_zoom <- df %>% filter(fecha >= as.Date("2023-01-01"))
    
    cat(sprintf("游늵 %s: %d registros cargados.\n", titulo_juego, nrow(df)))
    
    # Crear el Gr치fico
    p <- ggplot(df_zoom, aes(x = fecha, y = jugadores)) +
      # L칤nea base
      geom_line(color = "#2c3e50", alpha = 0.6, size = 0.8) +
      
      # Fines de Semana
      geom_point(data = subset(df_zoom, fin_de_semana == 1),
                 aes(color = "Fin de Semana"), size = 1, alpha = 0.6) +
      
      # Ofertas Steam
      geom_point(data = subset(df_zoom, oferta_steam == 1),
                 aes(color = "Oferta Steam"), size = 2.5, shape = 18) +
      
      # Est칠tica
      scale_color_manual(name = "Eventos Ex칩genos", 
                         values = c("Fin de Semana" = "#f39c12", "Oferta Steam" = "#e74c3c")) +
      labs(title = paste("Validaci칩n Visual:", titulo_juego),
           subtitle = "Zoom 2023-2025: Coincidencia de variables ex칩genas",
           y = "Jugadores Simult치neos", x = "") +
      theme_minimal() +
      theme(legend.position = "top")
    
    # IMPRIMIR EL GR츼FICO (Necesario dentro de un loop en RMarkdown)
    print(p)
    cat("\n------------------------------------------------\n")
    
  } else {
    cat(sprintf("丘멆잺 Alerta: No se encontr칩 el archivo para %s (%s)\n", titulo_juego, archivo))
  }
}
```

```{r}
# --- 5. MODELADO ARIMAX (CORREGIDO Y BLINDADO) ---
library(forecast)
library(tseries)
library(lmtest)

cat("Ajustando Regresi칩n Din치mica con Errores ARIMA (Manual)...\n")

# 1. Preparaci칩n de Datos (칔ltimos 4 a침os)
# -----------------------------------------------------------------------------
datos_model <- tail(df_unificado, 1460)
ts_jugadores <- ts(datos_model$jugadores, frequency = 7)

# 2. Matriz de Regresores (XREG)
xreg_df <- datos_model[, c("fin_de_semana", "oferta_steam")]
xreg_matrix <- as.matrix(xreg_df)

# DIAGN칍STICO DE SEGURIDAD (BLINDADO):
# Usamos 'stats::var' para asegurar que llamamos a la funci칩n de varianza
col_varianza <- apply(xreg_matrix, 2, stats::var)

if(any(col_varianza == 0)) {
  cat(" ALERTA: Una variable ex칩gena es constante (todo 0 o todo 1). Se eliminar치.\n")
  xreg_matrix <- xreg_matrix[, col_varianza > 0, drop = FALSE]
} else {
  cat("Diagn칩stico de regresores: OK (Tienen varianza).\n")
}

# 3. Split Train/Test
# -----------------------------------------------------------------------------
n_test <- 30
n_train <- length(ts_jugadores) - n_test

train_ts <- subset(ts_jugadores, end = n_train)
test_ts  <- subset(ts_jugadores, start = n_train + 1)

xreg_train <- xreg_matrix[1:n_train, , drop = FALSE]
xreg_test  <- xreg_matrix[(n_train + 1):length(ts_jugadores), , drop = FALSE]

cat("Datos de entrenamiento:", length(train_ts), "d칤as.\n")

# 4. Ajuste del Modelo (ARIMA Manual)
# -----------------------------------------------------------------------------
tryCatch({
  modelo_final <- Arima(
    train_ts,
    order = c(1, 1, 1),        # ARIMA(1,1,1) Est치ndar
    seasonal = list(order = c(1, 0, 0), period = 7), # Estacionalidad Semanal
    xreg = xreg_train,
    method = "CSS-ML"          # Algoritmo m치s estable
  )
  
  cat("Modelo ajustado exitosamente\n")
  
  # 5. Resultados
  # -----------------------------------------------------------------------------
  cat("\nRESUMEN DEL MODELO:\n")
  print(summary(modelo_final))
  
  cat("\nSIGNIFICANCIA DE VARIABLES (t-test):\n")
  print(coeftest(modelo_final))
  
  # 6. Diagn칩stico de Residuos
  # -----------------------------------------------------------------------------
  cat("\nREVISI칍N DE RESIDUOS:\n")
  checkresiduals(modelo_final)
  
}, error = function(e) {
  cat("Eror fatal en el ajuste:", e$message, "\n")
})
```




















